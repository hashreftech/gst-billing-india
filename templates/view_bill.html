{% extends "base.html" %}

{% block title %}Bill {{ bill.bill_number }} - GST Billing Software{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3">
                <i class="fas fa-file-invoice me-2"></i>Bill {{ bill.bill_number }}
            </h1>
            <div class="btn-group">
                <a href="{{ url_for('bills') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Bills
                </a>
                <a href="{{ url_for('download_bill_pdf', id=bill.id) }}" class="btn btn-success">
                    <i class="fas fa-download me-2"></i>Download PDF
                </a>
                <button type="button" class="btn btn-info" onclick="window.print()">
                    <i class="fas fa-print me-2"></i>Print
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Invoice Display -->
<div class="card invoice-card" id="invoiceContent">
    <div class="card-body">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12 text-center">
                <h2 class="text-primary mb-0">TAX INVOICE</h2>
            </div>
        </div>
        
        <!-- Company and Customer Details -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="company-details">
                    {% if company %}
                        <h5 class="text-primary">{{ company.name }}</h5>
                        <address class="mb-2">
                            {{ company.address|replace('\n', '<br>')|safe }}
                        </address>
                        <p class="mb-1"><strong>GSTIN:</strong> {{ company.gst_number }}</p>
                        <p class="mb-1"><strong>State:</strong> {{ company.state_code }}</p>
                        {% if company.tan_number %}
                            <p class="mb-0"><strong>TAN:</strong> {{ company.tan_number }}</p>
                        {% endif %}
                    {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Company details not configured. <a href="{{ url_for('company_config') }}">Configure now</a>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="customer-details">
                    <h6 class="text-primary">Bill To:</h6>
                    <h5>{{ bill.customer.name }}</h5>
                    {% if bill.customer.address %}
                        <address class="mb-2">
                            {{ bill.customer.address|replace('\n', '<br>')|safe }}
                        </address>
                    {% endif %}
                    {% if bill.customer.gst_number %}
                        <p class="mb-1"><strong>GSTIN:</strong> {{ bill.customer.gst_number }}</p>
                    {% endif %}
                    {% if bill.customer.state_code %}
                        <p class="mb-1"><strong>State:</strong> {{ bill.customer.state_code }}</p>
                    {% endif %}
                    {% if bill.customer.phone %}
                        <p class="mb-1"><strong>Phone:</strong> {{ bill.customer.phone }}</p>
                    {% endif %}
                    {% if bill.customer.email %}
                        <p class="mb-0"><strong>Email:</strong> {{ bill.customer.email }}</p>
                    {% endif %}
                    {% if bill.customer.is_guest %}
                        <span class="badge bg-secondary mt-2">Guest Customer</span>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Invoice Details -->
        <div class="row mb-4">
            <div class="col-md-6">
                <table class="table table-borderless table-sm">
                    <tr>
                        <td><strong>Invoice No:</strong></td>
                        <td>{{ bill.bill_number }}</td>
                    </tr>
                    <tr>
                        <td><strong>Invoice Date:</strong></td>
                        <td>{{ bill.bill_date.strftime('%d/%m/%Y') }}</td>
                    </tr>
                    {% if bill.due_date %}
                    <tr>
                        <td><strong>Due Date:</strong></td>
                        <td>
                            {{ bill.due_date.strftime('%d/%m/%Y') }}
                            {% if bill.due_date < bill.bill_date %}
                                <span class="badge bg-danger ms-1">Overdue</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                </table>
            </div>
            <div class="col-md-6">
                <div class="status-badge text-end">
                    <span class="badge bg-{% if bill.status == 'Paid' %}success{% elif bill.status == 'Sent' %}info{% elif bill.status == 'Cancelled' %}danger{% else %}secondary{% endif %} fs-6">
                        {{ bill.status }}
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Items Table -->
        <div class="table-responsive mb-4">
            <table class="table table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th style="width: 5%">S.No</th>
                        <th style="width: 30%">Description</th>
                        <th style="width: 8%">HSN</th>
                        <th style="width: 8%">Qty</th>
                        <th style="width: 8%">Unit</th>
                        <th style="width: 10%">Rate</th>
                        <th style="width: 10%">Amount</th>
                        <th style="width: 8%">GST%</th>
                        <th style="width: 10%">GST Amt</th>
                        <th style="width: 13%">Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in bill.items %}
                    {% set gst_amount = item.cgst_amount + item.sgst_amount + item.igst_amount %}
                    {% set total_amount = item.amount + gst_amount %}
                    <tr>
                        <td class="text-center">{{ loop.index }}</td>
                        <td>
                            <strong>{{ item.product_name }}</strong>
                            {% if item.description %}
                                <br><small class="text-muted">{{ item.description }}</small>
                            {% endif %}
                        </td>
                        <td>{{ item.hsn_code }}</td>
                        <td class="text-end">{{ "%.3f"|format(item.quantity|float) }}</td>
                        <td>{{ item.unit }}</td>
                        <td class="text-end">₹{{ "%.2f"|format(item.rate|float) }}</td>
                        <td class="text-end">₹{{ "%.2f"|format(item.amount|float) }}</td>
                        <td class="text-center">{{ "%.1f"|format(item.gst_rate|float) }}%</td>
                        <td class="text-end">₹{{ "%.2f"|format(gst_amount|float) }}</td>
                        <td class="text-end fw-bold">₹{{ "%.2f"|format(total_amount|float) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Totals Section -->
        <div class="row">
            <div class="col-md-6">
                <!-- GST Breakdown -->
                {% if bill.cgst_amount > 0 or bill.sgst_amount > 0 or bill.igst_amount > 0 %}
                <div class="card">
                    <div class="card-header py-2">
                        <h6 class="mb-0">GST Breakdown</h6>
                    </div>
                    <div class="card-body py-2">
                        <table class="table table-sm table-borderless mb-0">
                            {% if bill.cgst_amount > 0 %}
                            <tr>
                                <td>CGST:</td>
                                <td class="text-end">₹{{ "%.2f"|format(bill.cgst_amount|float) }}</td>
                            </tr>
                            {% endif %}
                            {% if bill.sgst_amount > 0 %}
                            <tr>
                                <td>SGST:</td>
                                <td class="text-end">₹{{ "%.2f"|format(bill.sgst_amount|float) }}</td>
                            </tr>
                            {% endif %}
                            {% if bill.igst_amount > 0 %}
                            <tr>
                                <td>IGST:</td>
                                <td class="text-end">₹{{ "%.2f"|format(bill.igst_amount|float) }}</td>
                            </tr>
                            {% endif %}
                        </table>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <div class="col-md-6">
                <div class="totals-section">
                    <table class="table table-borderless">
                        <tr>
                            <td><strong>Subtotal:</strong></td>
                            <td class="text-end"><strong>₹{{ "%.2f"|format(bill.subtotal|float) }}</strong></td>
                        </tr>
                        {% if bill.discount_amount and bill.discount_amount > 0 %}
                        <tr>
                            <td>Discount 
                                {% if bill.discount_type == 'percentage' %}({{ "%.1f"|format(bill.discount_value|float) }}%){% endif %}:
                            </td>
                            <td class="text-end text-success">-₹{{ "%.2f"|format(bill.discount_amount|float) }}</td>
                        </tr>
                        {% endif %}
                        {% if bill.cgst_amount > 0 %}
                        <tr>
                            <td>CGST:</td>
                            <td class="text-end">₹{{ "%.2f"|format(bill.cgst_amount|float) }}</td>
                        </tr>
                        {% endif %}
                        {% if bill.sgst_amount > 0 %}
                        <tr>
                            <td>SGST:</td>
                            <td class="text-end">₹{{ "%.2f"|format(bill.sgst_amount|float) }}</td>
                        </tr>
                        {% endif %}
                        {% if bill.igst_amount > 0 %}
                        <tr>
                            <td>IGST:</td>
                            <td class="text-end">₹{{ "%.2f"|format(bill.igst_amount|float) }}</td>
                        </tr>
                        {% endif %}
                        <tr class="border-top">
                            <td><strong class="fs-5">Total Amount:</strong></td>
                            <td class="text-end"><strong class="fs-5 text-primary">₹{{ "%.2f"|format(bill.total_amount|float) }}</strong></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Amount in Words -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="amount-words p-3 bg-light border rounded">
                    <strong>Amount in Words:</strong> 
                    {{ bill.total_amount|float|number_to_words }} Rupees Only
                </div>
            </div>
        </div>
        
        <!-- Notes -->
        {% if bill.notes %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="notes-section">
                    <h6>Notes:</h6>
                    <p class="mb-0">{{ bill.notes|replace('\n', '<br>')|safe }}</p>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Terms & Conditions -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="terms-section">
                    <h6>Terms & Conditions:</h6>
                    <ol class="small">
                        <li>Payment is due within 30 days of invoice date.</li>
                        <li>Interest @ 2% per month will be charged on overdue amounts.</li>
                        <li>All disputes subject to local jurisdiction only.</li>
                        <li>Goods once sold will not be taken back.</li>
                    </ol>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="row mt-4 pt-3 border-top">
            <div class="col-md-6">
                <small class="text-muted">
                    Generated on: {{ current_time }}<br>
                    Created: {{ bill.created_at.strftime('%d/%m/%Y %I:%M %p') }}
                </small>
            </div>
            <div class="col-md-6 text-end">
                {% if company %}
                    <p class="mb-0"><strong>{{ company.name }}</strong></p>
                    <small class="text-muted">Authorized Signatory</small>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Bill Actions -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Bill Actions</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Update Status:</h6>
                        <form method="POST" class="d-inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" name="action" value="update_status">
                            <select name="status" class="form-select d-inline-block w-auto me-2" onchange="this.form.submit()">
                                <option value="Draft" {% if bill.status == 'Draft' %}selected{% endif %}>Draft</option>
                                <option value="Sent" {% if bill.status == 'Sent' %}selected{% endif %}>Sent</option>
                                <option value="Paid" {% if bill.status == 'Paid' %}selected{% endif %}>Paid</option>
                                <option value="Cancelled" {% if bill.status == 'Cancelled' %}selected{% endif %}>Cancelled</option>
                            </select>
                        </form>
                    </div>
                    <div class="col-md-6">
                        <h6>Quick Actions:</h6>
                        <div class="btn-group">
                            <a href="{{ url_for('edit_bill', id=bill.id) }}" class="btn btn-outline-warning btn-sm">
                                <i class="fas fa-edit me-1"></i>Edit Bill
                            </a>
                            <a href="{{ url_for('download_bill_pdf', id=bill.id) }}" class="btn btn-outline-danger btn-sm" target="_blank">
                                <i class="fas fa-file-pdf me-1"></i>Download PDF
                            </a>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="copyInvoiceLink()">
                                <i class="fas fa-link me-1"></i>Copy Link
                            </button>
                            <button type="button" class="btn btn-outline-info btn-sm" onclick="emailInvoice()">
                                <i class="fas fa-envelope me-1"></i>Email
                            </button>
                            <button type="button" class="btn btn-outline-success btn-sm" onclick="duplicateInvoice()">
                                <i class="fas fa-copy me-1"></i>Duplicate
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function copyInvoiceLink() {
    const link = window.location.href;
    navigator.clipboard.writeText(link).then(function() {
        // Create a temporary toast notification
        const toast = document.createElement('div');
        toast.className = 'toast-notification';
        toast.textContent = 'Invoice link copied to clipboard!';
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bs-success);
            color: white;
            padding: 12px 20px;
            border-radius: 4px;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s;
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => toast.style.opacity = '1', 100);
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => document.body.removeChild(toast), 300);
        }, 3000);
    });
}

function emailInvoice() {
    const subject = `Invoice ${bill.bill_number} from {{ company.name if company else 'Company' }}`;
    const body = `Please find attached invoice ${bill.bill_number} for ₹{{ "%.2f"|format(bill.total_amount|float) }}.`;
    const email = `{{ bill.customer.email if bill.customer.email else '' }}`;
    
    const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.location.href = mailtoLink;
}

function duplicateInvoice() {
    if (confirm('Create a duplicate of this invoice?')) {
        // This would typically be handled server-side
        window.location.href = `{{ url_for('create_bill') }}?duplicate={{ bill.id }}`;
    }
}

// Print styles
const printStyles = `
@media print {
    .navbar, .btn, .card-header, .bill-actions, footer {
        display: none !important;
    }
    
    .invoice-card {
        border: none !important;
        box-shadow: none !important;
    }
    
    .card-body {
        padding: 0 !important;
    }
    
    body {
        font-size: 12px;
    }
    
    .table {
        font-size: 11px;
    }
    
    .container {
        max-width: 100% !important;
        padding: 0 !important;
    }
}
`;

// Add print styles to head
const styleSheet = document.createElement('style');
styleSheet.textContent = printStyles;
document.head.appendChild(styleSheet);

// Helper function for number to words (basic implementation)
function numberToWords(num) {
    // This is a basic implementation - in production, use a proper library
    if (num === 0) return "Zero";
    
    const ones = ["", "One", "Two", "Three", "Four", "Five", "Six", "Seven", "Eight", "Nine", "Ten", 
                  "Eleven", "Twelve", "Thirteen", "Fourteen", "Fifteen", "Sixteen", "Seventeen", 
                  "Eighteen", "Nineteen"];
    const tens = ["", "", "Twenty", "Thirty", "Forty", "Fifty", "Sixty", "Seventy", "Eighty", "Ninety"];
    
    function convertHundreds(n) {
        let result = "";
        if (n >= 100) {
            result += ones[Math.floor(n / 100)] + " Hundred ";
            n %= 100;
        }
        if (n >= 20) {
            result += tens[Math.floor(n / 10)] + " ";
            n %= 10;
        }
        if (n > 0) {
            result += ones[n] + " ";
        }
        return result;
    }
    
    let result = "";
    const intNum = Math.floor(num);
    
    if (intNum >= 10000000) {
        result += convertHundreds(Math.floor(intNum / 10000000)) + "Crore ";
        num %= 10000000;
    }
    if (intNum >= 100000) {
        result += convertHundreds(Math.floor(intNum / 100000)) + "Lakh ";
        num %= 100000;
    }
    if (intNum >= 1000) {
        result += convertHundreds(Math.floor(intNum / 1000)) + "Thousand ";
        num %= 1000;
    }
    if (intNum > 0) {
        result += convertHundreds(intNum);
    }
    
    return result.trim();
}

// Make number_to_words available globally for Jinja template
window.number_to_words = numberToWords;
</script>
{% endblock %}
