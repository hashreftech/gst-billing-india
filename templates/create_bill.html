{% extends "base.html" %}

{% block title %}{% if edit_mode %}Edit Bill{% else %}Create Bill{% endif %} - GST Billing Software{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3">
                <i class="fas fa-file-invoice-dollar me-2"></i>{% if edit_mode %}Edit Bill{% if bill %} - {{ bill.bill_number }}{% endif %}{% else %}Create New Bill{% endif %}
            </h1>
            <a href="{{ url_for('bills') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Bills
            </a>
        </div>
    </div>
</div>

<form method="POST" id="billForm">
    {{ form.hidden_tag() }}
    
    <!-- Hidden flag for edit mode detection in JavaScript -->
    <input type="hidden" id="editModeFlag" value="{{ 'true' if edit_mode else 'false' }}" />
    
    <div class="row">
        <!-- Customer Selection -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Customer Information</h5>
                    <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#quickCustomerModal">
                        <i class="fas fa-plus me-1"></i>Quick Add
                    </button>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.customer_id.label(class="form-label") }}
                            <span class="text-danger">*</span>
                            {{ form.customer_id(class="form-select" + (" is-invalid" if form.customer_id.errors else ""), id="customer_select") }}
                            {% if form.customer_id.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.customer_id.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            {{ form.bill_date.label(class="form-label") }}
                            <span class="text-danger">*</span>
                            {{ form.bill_date(class="form-control" + (" is-invalid" if form.bill_date.errors else "")) }}
                            {% if form.bill_date.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.bill_date.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            {{ form.due_date.label(class="form-label") }}
                            {{ form.due_date(class="form-control" + (" is-invalid" if form.due_date.errors else "")) }}
                            {% if form.due_date.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.due_date.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        {% if edit_mode %}
                        <div class="col-md-3 mb-3">
                            {{ form.status.label(class="form-label") }}
                            {{ form.status(class="form-select" + (" is-invalid" if form.status.errors else "")) }}
                            {% if form.status.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.status.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Discount Section -->
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            {{ form.discount_type.label(class="form-label") }}
                            {{ form.discount_type(class="form-select", id="discount_type", onchange="updateDiscountField()") }}
                        </div>
                        <div class="col-md-4 mb-3" id="discount_value_container" style="display: none;">
                            {{ form.discount_value.label(class="form-label", id="discount_value_label") }}
                            {{ form.discount_value(class="form-control", id="discount_value", oninput="updateSummary()", step="0.01") }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bill Summary -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Bill Summary</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <span>Subtotal:</span>
                        <span id="summary-subtotal">₹0.00</span>
                    </div>
                    <div class="d-flex justify-content-between" id="discount-row" style="display: none;">
                        <span>Discount:</span>
                        <span id="summary-discount">₹0.00</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>CGST:</span>
                        <span id="summary-cgst">₹0.00</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>SGST:</span>
                        <span id="summary-sgst">₹0.00</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>IGST:</span>
                        <span id="summary-igst">₹0.00</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between fw-bold">
                        <span>Total:</span>
                        <span id="summary-total">₹0.00</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Items Section -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Bill Items</h5>
            <button type="button" class="btn btn-primary btn-sm" onclick="addNewItem()">
                <i class="fas fa-plus me-1"></i>Add Item
            </button>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="itemsTable">
                    <thead>
                        <tr>
                            <th style="width: 22%">Product</th>
                            <th style="width: 12%">HSN</th>
                            <th style="width: 8%">Qty</th>
                            <th style="width: 6%">Unit</th>
                            <th style="width: 10%">Rate</th>
                            <th style="width: 6%">CGST%</th>
                            <th style="width: 6%">SGST%</th>
                            <th style="width: 12%">Amount</th>
                            <th style="width: 8%">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="itemsTableBody">
                        <!-- Items will be added dynamically -->
                    </tbody>
                </table>
            </div>
            
            <div class="text-center py-3" id="noItemsMessage">
                <i class="fas fa-box fs-1 text-muted mb-2"></i>
                <p class="text-muted">No items added yet. Click "Add Item" to get started.</p>
            </div>
        </div>
    </div>
    
    <!-- Notes -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Additional Information</h5>
        </div>
        <div class="card-body">
            {{ form.notes.label(class="form-label") }}
            {{ form.notes(class="form-control", rows="3", placeholder="Any additional notes or terms...") }}
        </div>
    </div>
    
    <!-- Actions -->
    <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-4">
        <a href="{{ url_for('bills') }}" class="btn btn-outline-secondary me-md-2">Cancel</a>
        <button type="submit" class="btn btn-primary" id="saveBillBtn" disabled>
            <i class="fas fa-save me-2"></i>{% if edit_mode %}Update Bill{% else %}Create Bill{% endif %}
        </button>
    </div>
</form>

<!-- Quick Customer Modal -->
<div class="modal fade" id="quickCustomerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Quick Add Customer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quickCustomerForm">
                    <div class="mb-3">
                        <label class="form-label">Customer Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="quick_customer_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="quick_customer_email">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone</label>
                        <input type="text" class="form-control" id="quick_customer_phone">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Address</label>
                        <textarea class="form-control" id="quick_customer_address" rows="2"></textarea>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="quick_customer_guest" checked>
                        <label class="form-check-label" for="quick_customer_guest">
                            Guest Customer
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveQuickCustomer()">Add Customer</button>
            </div>
        </div>
    </div>
</div>

<!-- Product Selection Modal -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" class="form-control" id="productSearch" placeholder="Search name, description, HSN, or any searchable field..." autocomplete="off">
                            <button class="btn btn-outline-primary" type="button" id="searchProductBtn">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div class="text-muted small mt-1">Type at least 2 characters to search</div>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="categoryFilter">
                            <option value="">All Categories</option>
                            <option value="General">General</option>
                            <option value="Electronics">Electronics</option>
                            <option value="Clothing">Clothing</option>
                            <option value="Food & Beverages">Food & Beverages</option>
                            <option value="Health & Beauty">Health & Beauty</option>
                            <option value="Home & Garden">Home & Garden</option>
                            <option value="Sports & Outdoors">Sports & Outdoors</option>
                            <option value="Automotive">Automotive</option>
                            <option value="Books & Stationery">Books & Stationery</option>
                            <option value="Services">Services</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-secondary w-100" onclick="resetProductSearch()">
                            <i class="fas fa-redo"></i> Reset
                        </button>
                    </div>
                </div>
                <div id="productLoadingIndicator" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading products...</p>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Category</th>
                                <th>HSN</th>
                                <th>Price</th>
                                <th>GST%</th>
                                <th>Unit</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="productTableBody">
                            <!-- Products will be loaded dynamically via AJAX -->
                        </tbody>
                    </table>
                </div>
                <div id="noProductsMessage" class="text-center py-4" style="display: none;">
                    <i class="fas fa-search fs-1 text-muted mb-2"></i>
                    <p class="text-muted">No products found matching your search criteria.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Add Product Modal -->
<div class="modal fade" id="quickAddProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Quick Add Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quickAddProductForm">
                    <div class="mb-3">
                        <label class="form-label">Product Name *</label>
                        <input type="text" class="form-control" id="quick_product_name" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Price *</label>
                                <input type="number" class="form-control" id="quick_product_price" step="0.01" min="0.01" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">HSN Code *</label>
                                <input type="text" class="form-control" id="quick_product_hsn" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">GST Rate (%) *</label>
                                <input type="number" class="form-control" id="quick_product_gst" step="0.1" min="0" max="100" value="18" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Unit *</label>
                                <input type="text" class="form-control" id="quick_product_unit" value="Nos" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <select class="form-select" id="quick_product_category">
                            <option value="General">General</option>
                            <option value="Electronics">Electronics</option>
                            <option value="Clothing">Clothing</option>
                            <option value="Food & Beverages">Food & Beverages</option>
                            <option value="Health & Beauty">Health & Beauty</option>
                            <option value="Home & Garden">Home & Garden</option>
                            <option value="Sports & Outdoors">Sports & Outdoors</option>
                            <option value="Automotive">Automotive</option>
                            <option value="Books & Stationery">Books & Stationery</option>
                            <option value="Services">Services</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="quick_product_description" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="saveQuickProduct()">Add Product</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables
let itemCounter = 0;
let currentItemRow = null;
window.cachedProducts = [];

// Initialize with any pre-loaded products if provided
{% if products %}
try {
    window.cachedProducts = {{ products|tojson }}.slice(0, 20); // Only keep first 20 for initial cache
} catch (e) {
    console.error('Error initializing cached products:', e);
}
{% endif %}

// Initialize form
document.addEventListener('DOMContentLoaded', function() {
    // Set today's date as default if not editing
    {% if not edit_mode %}
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('bill_date').value = today;
    {% endif %}
    
    // Initialize discount field visibility
    updateDiscountField();
    
    // Load existing items if in edit mode or duplicating, otherwise add first item row
    {% if edit_mode and bill.items %}
    {% for item in bill.items %}
    loadExistingItem(
        {{ item.product_id if item.product_id else 0 }}, 
        {{ item.quantity if item.quantity else 1 }}, 
        '{{ item.product_name|replace("'", "\\'") if item.product_name else "" }}', 
        '{{ item.hsn_code if item.hsn_code else "" }}', 
        '{{ item.unit if item.unit else "" }}', 
        {{ item.rate if item.rate else 0 }}, 
        {{ item.gst_rate if item.gst_rate else 0 }}, 
        '{{ item.description|replace("'", "\\'") if item.description else "" }}',
        {{ item.cgst_rate if item.cgst_rate else item.gst_rate/2 }},
        {{ item.sgst_rate if item.sgst_rate else item.gst_rate/2 }}
    );
    {% endfor %}
    // Calculate totals after loading all items and enable the save button
    setTimeout(() => {
        updateSummary();
        // Enable save button for edit mode
        const saveBillBtn = document.getElementById('saveBillBtn');
        if (saveBillBtn) {
            saveBillBtn.disabled = false;
        }
    }, 200);
    {% elif duplicate_bill and duplicate_bill.items %}
    {% for item in duplicate_bill.items %}
    loadExistingItem(
        {{ item.product_id if item.product_id else 0 }}, 
        {{ item.quantity if item.quantity else 1 }}, 
        '{{ item.product_name|replace("'", "\\'") if item.product_name else "" }}', 
        '{{ item.hsn_code if item.hsn_code else "" }}', 
        '{{ item.unit if item.unit else "" }}', 
        {{ item.rate if item.rate else 0 }}, 
        {{ item.gst_rate if item.gst_rate else 0 }}, 
        '{{ item.description|replace("'", "\\'") if item.description else "" }}',
        {{ item.cgst_rate if item.cgst_rate else item.gst_rate/2 }},
        {{ item.sgst_rate if item.sgst_rate else item.gst_rate/2 }}
    );
    {% endfor %}
    // Calculate totals after loading duplicate items
    setTimeout(() => {
        updateSummary();
    }, 200);
    {% else %}
    addNewItem();
    {% endif %}
    
    // Initialize product search and filters
    const productSearchInput = document.getElementById('productSearch');
    if (productSearchInput) {
        productSearchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                filterProducts();
            }
        });
        
        // Add search delay for typing (debounce)
        let searchTimeout = null;
        productSearchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(function() {
                const searchTerm = productSearchInput.value.trim();
                if (searchTerm.length >= 2) {
                    filterProducts();
                }
            }, 500); // 500ms delay after typing stops
        });
    }
    
    // Search button click handler
    const searchProductBtn = document.getElementById('searchProductBtn');
    if (searchProductBtn) {
        searchProductBtn.addEventListener('click', filterProducts);
    }
    
    // Category filter
    const categoryFilterSelect = document.getElementById('categoryFilter');
    if (categoryFilterSelect) {
        categoryFilterSelect.addEventListener('change', filterProducts);
    }
    
    // Initial product load when modal opens
    document.getElementById('productModal').addEventListener('shown.bs.modal', function() {
        // Clear any previous search and load recent products
        resetProductSearch();
    });
});

function addNewItem() {
    itemCounter++;
    const tbody = document.getElementById('itemsTableBody');
    const row = document.createElement('tr');
    row.id = `item-row-${itemCounter}`;
    
    // Create basic product options dropdown (will be populated via AJAX when needed)
    let productOptions = '<option value="">Select Product</option>';
    
    // Add any cached products if available (loaded via AJAX previously)
    if (window.cachedProducts && window.cachedProducts.length > 0) {
        window.cachedProducts.forEach(product => {
            const price = parseFloat(product.price || 0);
            productOptions += `<option value="${product.id}" 
                data-name="${product.name || ''}" 
                data-hsn="${product.hsn_code || ''}" 
                data-unit="${product.unit || 'Nos'}" 
                data-rate="${price}" 
                data-gst="${product.gst_rate || 0}" 
                data-cgst="${product.cgst_rate || (product.gst_rate ? product.gst_rate/2 : 0)}" 
                data-sgst="${product.sgst_rate || (product.gst_rate ? product.gst_rate/2 : 0)}" 
                data-description="${product.description || ''}">${product.name || ''} - ₹${price.toFixed(2)}</option>`;
        });
    }
    
    row.innerHTML = `
        <td>
            <select class="form-select" name="items-${itemCounter-1}-product_id" required onchange="updateItemFromProduct(this, ${itemCounter})">
                ${productOptions}
            </select>
            <button type="button" class="btn btn-link btn-sm p-0 mt-1" onclick="openProductModal(${itemCounter})">
                <i class="fas fa-search"></i> Browse Products
            </button>
            <small class="text-muted product-details"></small>
            <input type="hidden" name="items-${itemCounter-1}-product_name" class="product-name-field">
            <input type="hidden" name="items-${itemCounter-1}-description" class="description-field">
        </td>
        <td>
            <span class="hsn-display">-</span>
            <input type="hidden" name="items-${itemCounter-1}-hsn_code" class="hsn-field">
        </td>
        <td>
            <input type="number" class="form-control" name="items-${itemCounter-1}-quantity" 
                   step="0.001" min="0.001" value="1" required onchange="calculateItemAmount(${itemCounter})">
        </td>
        <td>
            <span class="unit-display">-</span>
            <input type="hidden" name="items-${itemCounter-1}-unit" class="unit-field">
        </td>
        <td>
            <span class="rate-display">₹0.00</span>
            <input type="hidden" name="items-${itemCounter-1}-rate" class="rate-field">
        </td>
        <td>
            <span class="cgst-display">0%</span>
            <input type="hidden" name="items-${itemCounter-1}-cgst_rate" class="cgst-field" value="0">
        </td>
        <td>
            <span class="sgst-display">0%</span>
            <input type="hidden" name="items-${itemCounter-1}-sgst_rate" class="sgst-field" value="0">
            <input type="hidden" name="items-${itemCounter-1}-gst_rate" class="gst-field" value="0">
        </td>
        <td>
            <span class="item-amount fw-bold">₹0.00</span>
        </td>
        <td>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeItem(${itemCounter})">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;
    
    tbody.appendChild(row);
    document.getElementById('noItemsMessage').style.display = 'none';
    updateFormButtons();
}

function updateItemFromProduct(selectElement, itemId) {
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    const row = selectElement.closest('tr');
    
    if (selectedOption.value === '') {
        // Reset fields if no product selected
        row.querySelector('.hsn-display').textContent = '-';
        row.querySelector('.unit-display').textContent = '-';
        row.querySelector('.rate-display').textContent = '₹0.00';
        row.querySelector('.cgst-display').textContent = '0%';
        row.querySelector('.sgst-display').textContent = '0%';
        row.querySelector('.product-details').textContent = '';
        
        // Clear hidden fields
        row.querySelector('.hsn-field').value = '';
        row.querySelector('.unit-field').value = '';
        row.querySelector('.rate-field').value = '';
        row.querySelector('.cgst-field').value = '';
        row.querySelector('.sgst-field').value = '';
        row.querySelector('.gst-field').value = '';
        row.querySelector('.product-name-field').value = '';
        row.querySelector('.description-field').value = '';
        
        calculateItemAmount(itemId);
        return;
    }
    
    // Get product data from option attributes
    const hsn = selectedOption.dataset.hsn || '';
    const unit = selectedOption.dataset.unit || 'Nos';
    const rate = parseFloat(selectedOption.dataset.rate) || 0;
    const gstRate = parseFloat(selectedOption.dataset.gst) || 18;
    const cgstRate = parseFloat(selectedOption.dataset.cgst) || (gstRate / 2);
    const sgstRate = parseFloat(selectedOption.dataset.sgst) || (gstRate / 2);
    const description = selectedOption.dataset.description || '';
    const productName = selectedOption.dataset.name || selectedOption.textContent.split(' - ₹')[0];
    
    // Update display fields
    row.querySelector('.hsn-display').textContent = hsn;
    row.querySelector('.unit-display').textContent = unit;
    row.querySelector('.rate-display').textContent = `₹${rate.toFixed(2)}`;
    row.querySelector('.cgst-display').textContent = `${cgstRate}%`;
    row.querySelector('.sgst-display').textContent = `${sgstRate}%`;
    row.querySelector('.product-details').textContent = description;
    
    // Update hidden form fields
    row.querySelector('.hsn-field').value = hsn;
    row.querySelector('.unit-field').value = unit;
    row.querySelector('.rate-field').value = rate;
    row.querySelector('.cgst-field').value = cgstRate;
    row.querySelector('.sgst-field').value = sgstRate;
    row.querySelector('.gst-field').value = gstRate;
    row.querySelector('.product-name-field').value = productName;
    row.querySelector('.description-field').value = description;
    
    // Recalculate amount
    calculateItemAmount(itemId);
}

function loadExistingItem(productId, quantity, productName, hsnCode, unit, rate, gstRate, description, cgstRate, sgstRate) {
    itemCounter++;
    const tbody = document.getElementById('itemsTableBody');
    const row = document.createElement('tr');
    row.id = `item-row-${itemCounter}`;
    
    // Set default values for cgst and sgst if not provided
    if (cgstRate === undefined) cgstRate = gstRate / 2;
    if (sgstRate === undefined) sgstRate = gstRate / 2;
    
    // Create basic product options dropdown
    let productOptions = '<option value="">Select Product</option>';
    
    // Initialize cached products array if not exists
    if (!window.cachedProducts) {
        window.cachedProducts = [];
    }
    
    // If we have a product ID, fetch the details and add to cached products
    if (productId > 0) {
        // Check if we already have this product in cache
        const cachedProduct = window.cachedProducts.find(p => p.id === parseInt(productId));
        
        if (!cachedProduct) {
            // Add a temporary option while we load the product
            productOptions += `<option value="${productId}" selected>${productName}</option>`;
            
            // Store the current row ID to ensure updates go to the correct row
            const currentRowId = itemCounter;
            
            // Fetch the product details asynchronously
            fetch(`/api/products/${productId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.product) {
                        // Make sure we don't add duplicates
                        const existingIndex = window.cachedProducts.findIndex(p => p.id === data.product.id);
                        if (existingIndex >= 0) {
                            window.cachedProducts[existingIndex] = data.product;
                        } else {
                            // Add to cache for future use
                            window.cachedProducts.push(data.product);
                        }
                        
                        // Get the specific row we need to update using the stored ID
                        const specificRow = document.getElementById(`item-row-${currentRowId}`);
                        if (!specificRow) {
                            console.error(`Row ${currentRowId} not found when updating product`);
                            return;
                        }
                        
                        // Update the option with complete data
                        const selectElement = specificRow.querySelector(`select[name*="product_id"]`);
                        if (selectElement) {
                            const option = selectElement.querySelector(`option[value="${productId}"]`);
                            if (option) {
                                option.textContent = `${data.product.name} - ₹${data.product.price.toFixed(2)}`;
                                option.dataset.name = data.product.name;
                                option.dataset.hsn = data.product.hsn_code;
                                option.dataset.unit = data.product.unit;
                                option.dataset.rate = data.product.price;
                                option.dataset.gst = data.product.gst_rate;
                                option.dataset.cgst = data.product.cgst_rate || (data.product.gst_rate / 2);
                                option.dataset.sgst = data.product.sgst_rate || (data.product.gst_rate / 2);
                                option.dataset.description = data.product.description || '';
                            }
                        }
                    }
                })
                .catch(error => console.error('Error fetching product:', error));
        } else {
            // We have the product in cache, add it as selected
            // Use the cached product data, but preserve the original values passed to this function
            // for rate, gst_rate, etc., as they might have been customized
            const price = parseFloat(rate || cachedProduct.price || 0);
            productOptions += `<option value="${cachedProduct.id}" selected 
                data-name="${cachedProduct.name || productName || ''}" 
                data-hsn="${hsnCode || cachedProduct.hsn_code || ''}" 
                data-unit="${unit || cachedProduct.unit || 'Nos'}" 
                data-rate="${price}" 
                data-gst="${gstRate || cachedProduct.gst_rate || 0}" 
                data-cgst="${cgstRate || cachedProduct.cgst_rate || (cachedProduct.gst_rate ? cachedProduct.gst_rate/2 : 0)}" 
                data-sgst="${sgstRate || cachedProduct.sgst_rate || (cachedProduct.gst_rate ? cachedProduct.gst_rate/2 : 0)}" 
                data-description="${description || cachedProduct.description || ''}">${cachedProduct.name || productName || ''} - ₹${price.toFixed(2)}</option>`;
        }
    } else if (productName) {
        // Custom product (no ID)
        productOptions += `<option value="0" selected>${productName}</option>`;
    }
    
    // Add any other cached products we might have - but don't add too many to avoid making the dropdown too big
    // We'll use the browse products feature for a more complete list
    let cachedProductsAdded = 0;
    const maxCachedProductsToShow = 30; // Limit to avoid very large dropdowns
    
    if (window.cachedProducts && window.cachedProducts.length > 0) {
        window.cachedProducts.forEach(product => {
            // Only add a limited number of cached products, and skip the current one
            if (cachedProductsAdded < maxCachedProductsToShow && product.id !== parseInt(productId)) {
                const price = parseFloat(product.price || 0);
                productOptions += `<option value="${product.id}" 
                    data-name="${product.name || ''}" 
                    data-hsn="${product.hsn_code || ''}" 
                    data-unit="${product.unit || 'Nos'}" 
                    data-rate="${price}" 
                    data-gst="${product.gst_rate || 0}" 
                    data-cgst="${product.cgst_rate || (product.gst_rate ? product.gst_rate/2 : 0)}" 
                    data-sgst="${product.sgst_rate || (product.gst_rate ? product.gst_rate/2 : 0)}" 
                    data-description="${product.description || ''}">${product.name || ''} - ₹${price.toFixed(2)}</option>`;
                cachedProductsAdded++;
            }
        });
    }
    
    row.innerHTML = `
        <td>
            <select class="form-select" name="items-${itemCounter-1}-product_id" required onchange="updateItemFromProduct(this, ${itemCounter})">
                ${productOptions}
            </select>
            <button type="button" class="btn btn-link btn-sm p-0 mt-1" onclick="openProductModal(${itemCounter})">
                <i class="fas fa-search"></i> Browse Products
            </button>
            <small class="text-muted product-details">${description}</small>
            <input type="hidden" name="items-${itemCounter-1}-product_name" class="product-name-field" value="${productName}">
            <input type="hidden" name="items-${itemCounter-1}-description" class="description-field" value="${description}">
        </td>
        <td>
            <span class="hsn-display">${hsnCode}</span>
            <input type="hidden" name="items-${itemCounter-1}-hsn_code" class="hsn-field" value="${hsnCode}">
        </td>
        <td>
            <input type="number" class="form-control" name="items-${itemCounter-1}-quantity" 
                   step="0.001" min="0.001" value="${quantity}" required onchange="calculateItemAmount(${itemCounter})">
        </td>
        <td>
            <span class="unit-display">${unit}</span>
            <input type="hidden" name="items-${itemCounter-1}-unit" class="unit-field" value="${unit}">
        </td>
        <td>
            <span class="rate-display">₹${parseFloat(rate).toFixed(2)}</span>
            <input type="hidden" name="items-${itemCounter-1}-rate" class="rate-field" value="${rate}">
        </td>
        <td>
            <span class="cgst-display">${cgstRate}%</span>
            <input type="hidden" name="items-${itemCounter-1}-cgst_rate" class="cgst-field" value="${cgstRate}">
        </td>
        <td>
            <span class="sgst-display">${sgstRate}%</span>
            <input type="hidden" name="items-${itemCounter-1}-sgst_rate" class="sgst-field" value="${sgstRate}">
            <input type="hidden" name="items-${itemCounter-1}-gst_rate" class="gst-field" value="${gstRate}">
        </td>
        <td>
            <span class="item-amount fw-bold">₹${(parseFloat(quantity) * parseFloat(rate)).toFixed(2)}</span>
        </td>
        <td>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeItem(${itemCounter})">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;
    
    tbody.appendChild(row);
    document.getElementById('noItemsMessage').style.display = 'none';
    
    // Force immediate calculation for this loaded item
    setTimeout(() => {
        calculateItemAmount(itemCounter);
        updateSummary();
    }, 50);
    
    updateFormButtons();
}

function removeItem(itemId) {
    const row = document.getElementById(`item-row-${itemId}`);
    if (row) {
        row.remove();
        updateSummary();
        updateFormButtons();
        
        // Show no items message if no rows left
        const tbody = document.getElementById('itemsTableBody');
        if (tbody.children.length === 0) {
            document.getElementById('noItemsMessage').style.display = 'block';
        }
    }
}

function openProductModal(itemId) {
    currentItemRow = itemId;
    const modal = new bootstrap.Modal(document.getElementById('productModal'));
    
    // Get the current product name if any
    const row = document.getElementById(`item-row-${itemId}`);
    if (row) {
        const currentProductName = row.querySelector('.product-name-field').value;
        const searchInput = document.getElementById('productSearch');
        
        // Pre-fill search box with current product name for easier searching
        if (currentProductName && currentProductName.trim() !== '') {
            searchInput.value = currentProductName;
            // Trigger a search with the current product name
            filterProducts();
        } else {
            // Clear previous search
            searchInput.value = '';
            document.getElementById('productTableBody').innerHTML = '';
            
            // Show recently used products if we have them cached
            if (window.cachedProducts && window.cachedProducts.length > 0) {
                // Display a message about recent products
                document.getElementById('noProductsMessage').style.display = 'none';
                document.getElementById('productLoadingIndicator').style.display = 'none';
                
                const tbody = document.getElementById('productTableBody');
                const recentHeading = document.createElement('tr');
                recentHeading.innerHTML = '<td colspan="7" class="bg-light text-center fw-bold">Recently Used Products</td>';
                tbody.appendChild(recentHeading);
                
                // Show up to 5 most recent products
                const recentProducts = window.cachedProducts.slice(0, 5);
                recentProducts.forEach(product => {
                    const row = document.createElement('tr');
                    
                    // Build name cell content
                    let nameContent = `<strong>${escapeHtml(product.name)}</strong>`;
                    if (product.description) {
                        nameContent += `<br><small class="text-muted">${escapeHtml(product.description)}</small>`;
                    }
                    
                    row.innerHTML = `
                        <td>${nameContent}</td>
                        <td><span class="badge bg-secondary">${escapeHtml(product.category || 'General')}</span></td>
                        <td>${escapeHtml(product.hsn_code || '')}</td>
                        <td>₹${parseFloat(product.price || 0).toFixed(2)}</td>
                        <td>${parseFloat(product.gst_rate || 0).toFixed(1)}%</td>
                        <td>${escapeHtml(product.unit || 'Nos')}</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-primary" onclick="selectProduct(${product.id})">
                                Select
                            </button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
            }
        }
    }
    
    modal.show();
    
    // Focus on search input
    setTimeout(() => {
        document.getElementById('productSearch').focus();
    }, 300);
}

function selectProduct(productId) {
    // Get the current row we're working with
    if (!currentItemRow) {
        console.error('No item row selected');
        return;
    }
    
    const row = document.getElementById(`item-row-${currentItemRow}`);
    if (!row) {
        console.error(`Item row ${currentItemRow} not found`);
        return;
    }
    
    // Store the specific row ID to make sure we're updating the correct row
    const rowToUpdate = currentItemRow;
    console.log(`Selecting product ${productId} for row ${rowToUpdate}`);
    
    // Get product details via AJAX
    fetch(`/api/products/${productId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Network response was not ok: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data.product) {
                throw new Error('Product data is missing');
            }
            
            const product = data.product;
            console.log('Product data received:', product);
            
            // Add to global cache for later use in other rows
            if (!window.cachedProducts) {
                window.cachedProducts = [];
            }
            
            // Update or add to cache - move to the front to maintain most recently used order
            const existingIndex = window.cachedProducts.findIndex(p => p.id === product.id);
            if (existingIndex >= 0) {
                // Remove from current position
                const existingProduct = window.cachedProducts.splice(existingIndex, 1)[0];
                
                // Merge any updated properties
                Object.assign(existingProduct, product);
                
                // Add to the beginning of the array (most recently used first)
                window.cachedProducts.unshift(existingProduct);
            } else {
                // Add new product to the beginning of the array
                window.cachedProducts.unshift(product);
                
                // Limit cache size to avoid excessive memory usage
                if (window.cachedProducts.length > 100) {
                    window.cachedProducts = window.cachedProducts.slice(0, 100);
                }
            }
            
            // Now update the dropdown in this specific row - using the stored rowToUpdate value
            // to ensure we're working with the correct row that initiated the selection
            const specificRow = document.getElementById(`item-row-${rowToUpdate}`);
            if (!specificRow) {
                throw new Error(`Item row ${rowToUpdate} not found`);
            }
            
            const selectElement = specificRow.querySelector('select[name*="product_id"]');
            if (!selectElement) {
                throw new Error('Product select element not found');
            }
            
            // First clear all other options except the empty default one
            while (selectElement.options.length > 1) {
                selectElement.remove(1);
            }
            
            // Create a new option for this product
            const option = document.createElement('option');
            option.value = product.id;
            selectElement.appendChild(option);
            
            // Update the option data
            const price = parseFloat(product.price || 0);
            option.textContent = `${product.name} - ₹${price.toFixed(2)}`;
            option.dataset.name = product.name || '';
            option.dataset.hsn = product.hsn_code || '';
            option.dataset.unit = product.unit || 'Nos';
            option.dataset.rate = price;
            option.dataset.gst = product.gst_rate || 0;
            option.dataset.cgst = product.cgst_rate || (product.gst_rate / 2) || 0;
            option.dataset.sgst = product.sgst_rate || (product.gst_rate / 2) || 0;
            option.dataset.description = product.description || '';
            
            // Select this option
            selectElement.value = product.id;
            
            // Update the row fields with product data
            const cgstRate = product.cgst_rate || (product.gst_rate / 2) || 0;
            const sgstRate = product.sgst_rate || (product.gst_rate / 2) || 0;
            
            // Update display fields - make sure we're using specificRow (not row)
            // to prevent any race conditions with multiple async product lookups
            specificRow.querySelector('.hsn-display').textContent = product.hsn_code || '';
            specificRow.querySelector('.unit-display').textContent = product.unit || 'Nos';
            specificRow.querySelector('.rate-display').textContent = `₹${price.toFixed(2)}`;
            specificRow.querySelector('.cgst-display').textContent = `${cgstRate}%`;
            specificRow.querySelector('.sgst-display').textContent = `${sgstRate}%`;
            specificRow.querySelector('.product-details').textContent = product.description || '';
            
            // Update hidden form fields
            specificRow.querySelector('.hsn-field').value = product.hsn_code || '';
            specificRow.querySelector('.unit-field').value = product.unit || 'Nos';
            specificRow.querySelector('.rate-field').value = price;
            specificRow.querySelector('.cgst-field').value = cgstRate;
            specificRow.querySelector('.sgst-field').value = sgstRate;
            specificRow.querySelector('.gst-field').value = product.gst_rate || 0;
            specificRow.querySelector('.product-name-field').value = product.name || '';
            specificRow.querySelector('.description-field').value = product.description || '';
            
            // Recalculate amount for this row
            calculateItemAmount(rowToUpdate);
            
            // Close the product selection modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
            if (modal) {
                modal.hide();
            } else {
                console.error('Modal instance not found');
            }
            
            console.log(`Successfully updated row ${currentItemRow} with product ${product.id}`);
        })
        .catch(error => {
            console.error('Error selecting product:', error);
            alert('Error loading product details. Please try again.');
        });
}

function calculateItemAmount(itemId) {
    const row = document.getElementById(`item-row-${itemId}`);
    const quantity = parseFloat(row.querySelector(`input[name="items-${itemId-1}-quantity"]`).value) || 0;
    const rate = parseFloat(row.querySelector(`input[name="items-${itemId-1}-rate"]`).value) || 0;
    
    const amount = quantity * rate;
    row.querySelector('.item-amount').textContent = `₹${amount.toFixed(2)}`;
    
    // Update total summary after calculating this item
    updateSummary();
    updateFormButtons();
}

// Update discount field visibility and label
function updateDiscountField() {
    const discountType = document.getElementById('discount_type');
    const discountContainer = document.getElementById('discount_value_container');
    const discountLabel = document.getElementById('discount_value_label');
    const discountInput = document.getElementById('discount_value');
    
    if (!discountType) return;
    
    if (discountType.value === 'none') {
        discountContainer.style.display = 'none';
        if (discountInput) discountInput.value = '';
    } else {
        discountContainer.style.display = 'block';
        if (discountType.value === 'percentage') {
            discountLabel.textContent = 'Discount Percentage (%)';
            discountInput.setAttribute('max', '100');
            discountInput.setAttribute('placeholder', 'Enter percentage (0-100)');
        } else if (discountType.value === 'amount') {
            discountLabel.textContent = 'Discount Amount (₹)';
            discountInput.removeAttribute('max');
            discountInput.setAttribute('placeholder', 'Enter amount');
        }
    }
    updateSummary();
}

function updateSummary() {
    let subtotal = 0;
    let totalCGST = 0;
    let totalSGST = 0;
    let totalIGST = 0;
    
    // Get company and customer state codes for GST calculation
    const companyState = '27'; // Default to Maharashtra, should be from company config
    const customerSelect = document.getElementById('customer_select');
    const customerState = customerSelect.value ? companyState : companyState; // Simplified for now
    
    const tbody = document.getElementById('itemsTableBody');
    const rows = tbody.querySelectorAll('tr');
    
    rows.forEach((row, index) => {
        const quantity = parseFloat(row.querySelector(`input[name="items-${index}-quantity"]`).value) || 0;
        const rate = parseFloat(row.querySelector(`input[name="items-${index}-rate"]`).value) || 0;
        const cgstRate = parseFloat(row.querySelector(`input[name="items-${index}-cgst_rate"]`).value) || 0;
        const sgstRate = parseFloat(row.querySelector(`input[name="items-${index}-sgst_rate"]`).value) || 0;
        
        const amount = quantity * rate;
        subtotal += amount;
        
        if (companyState === customerState) {
            // Intra-state: CGST + SGST (use individual rates)
            totalCGST += (amount * cgstRate) / 100;
            totalSGST += (amount * sgstRate) / 100;
        } else {
            // Inter-state: IGST (combined rate)
            totalIGST += (amount * (cgstRate + sgstRate)) / 100;
        }
    });
    
    // Calculate discount
    let discountAmount = 0;
    const discountType = document.getElementById('discount_type') ? document.getElementById('discount_type').value : 'none';
    const discountValue = parseFloat(document.getElementById('discount_value') ? document.getElementById('discount_value').value : 0) || 0;
    
    if (discountType === 'percentage' && discountValue > 0) {
        const validPercentage = Math.min(Math.max(discountValue, 0), 100);
        if (document.getElementById('discount_value') && discountValue !== validPercentage) {
            document.getElementById('discount_value').value = validPercentage;
        }
        discountAmount = (subtotal * validPercentage) / 100;
    } else if (discountType === 'amount' && discountValue > 0) {
        const validAmount = Math.min(Math.max(discountValue, 0), subtotal);
        if (document.getElementById('discount_value') && discountValue !== validAmount) {
            document.getElementById('discount_value').value = validAmount;
        }
        discountAmount = validAmount;
    }
    
    // Show/hide discount row
    const discountRow = document.getElementById('discount-row');
    if (discountRow) {
        if (discountAmount > 0) {
            discountRow.style.display = 'flex';
            const discountEl = document.getElementById('summary-discount');
            if (discountEl) discountEl.textContent = `-₹${discountAmount.toFixed(2)}`;
        } else {
            discountRow.style.display = 'none';
        }
    }
    
    const total = subtotal - discountAmount + totalCGST + totalSGST + totalIGST;
    
    // Update summary display with null checks
    const subtotalEl = document.getElementById('summary-subtotal');
    const cgstEl = document.getElementById('summary-cgst');
    const sgstEl = document.getElementById('summary-sgst');
    const igstEl = document.getElementById('summary-igst');
    const totalEl = document.getElementById('summary-total');
    
    if (subtotalEl) subtotalEl.textContent = `₹${subtotal.toFixed(2)}`;
    if (cgstEl) cgstEl.textContent = `₹${totalCGST.toFixed(2)}`;
    if (sgstEl) sgstEl.textContent = `₹${totalSGST.toFixed(2)}`;
    if (igstEl) igstEl.textContent = `₹${totalIGST.toFixed(2)}`;
    if (totalEl) totalEl.textContent = `₹${total.toFixed(2)}`;
}

function updateFormButtons() {
    const tbody = document.getElementById('itemsTableBody');
    const hasItems = tbody ? tbody.children.length > 0 : false;
    const customerSelect = document.getElementById('customer_select');
    const customerSelected = customerSelect ? customerSelect.value : '';
    const saveBillBtn = document.getElementById('saveBillBtn');
    
    if (saveBillBtn) {
        // Check if we're in edit mode (set from server-side)
        const editMode = document.getElementById('editModeFlag') ? 
                         document.getElementById('editModeFlag').value === 'true' : false;
        
        // In edit mode, we already have a bill, so enable the button if a customer is selected
        // In create mode, we need both items and customer
        if (editMode) {
            saveBillBtn.disabled = !customerSelected;
        } else {
            saveBillBtn.disabled = !(hasItems && customerSelected);
        }
    }
}

function filterProducts() {
    const searchTerm = document.getElementById('productSearch').value.trim();
    const categoryFilter = document.getElementById('categoryFilter').value;
    
    // Skip search if term is too short
    if (searchTerm.length < 2 && !categoryFilter) {
        return;
    }
    
    // Show loading indicator and hide messages
    document.getElementById('productLoadingIndicator').style.display = 'block';
    document.getElementById('noProductsMessage').style.display = 'none';
    
    // Clear current table content
    document.getElementById('productTableBody').innerHTML = '';
    
    // Send AJAX request to search for products
    fetch(`/api/products/search?term=${encodeURIComponent(searchTerm)}&category=${encodeURIComponent(categoryFilter)}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            const tbody = document.getElementById('productTableBody');
            
            // Hide loading indicator
            document.getElementById('productLoadingIndicator').style.display = 'none';
            
            // Check if we got any products
            if (data.products && data.products.length > 0) {
                // Populate the table with products
                data.products.forEach(product => {
                    const row = document.createElement('tr');
                    row.dataset.category = product.category || 'General';
                    
                    // Build name cell content with custom fields if available
                    let nameContent = `<strong>${escapeHtml(product.name)}</strong>`;
                    if (product.description) {
                        nameContent += `<br><small class="text-muted">${escapeHtml(product.description)}</small>`;
                    }
                    
                    // Add any searchable custom field values as badges below the description
                    if (product.custom_fields && Object.keys(product.custom_fields).length > 0) {
                        nameContent += '<div class="mt-1">';
                        for (const [fieldName, fieldData] of Object.entries(product.custom_fields)) {
                            // Highlight the field if it contains the search term
                            const searchTerm = document.getElementById('productSearch').value.trim();
                            const fieldValue = fieldData.value;
                            let bgClass = 'bg-info';
                            
                            // Check if this field value contains the search term
                            if (searchTerm && fieldValue.toLowerCase().includes(searchTerm.toLowerCase())) {
                                bgClass = 'bg-success'; // Use a different color to highlight matching fields
                            }
                            
                            nameContent += `<span class="badge ${bgClass} me-1" title="${escapeHtml(fieldData.display_name)}">${escapeHtml(fieldData.display_name)}: ${escapeHtml(fieldData.value)}</span>`;
                        }
                        nameContent += '</div>';
                    }
                    
                    row.innerHTML = `
                        <td>${nameContent}</td>
                        <td><span class="badge bg-secondary">${escapeHtml(product.category || 'General')}</span></td>
                        <td>${escapeHtml(product.hsn_code)}</td>
                        <td>₹${parseFloat(product.price).toFixed(2)}</td>
                        <td>${parseFloat(product.gst_rate).toFixed(1)}%</td>
                        <td>${escapeHtml(product.unit)}</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-primary" onclick="selectProduct(${product.id})">
                                Select
                            </button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
            } else {
                // Show no products message
                document.getElementById('noProductsMessage').style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error fetching products:', error);
            document.getElementById('productLoadingIndicator').style.display = 'none';
            document.getElementById('noProductsMessage').style.display = 'block';
            document.getElementById('noProductsMessage').querySelector('p').textContent = 'Error loading products. Please try again.';
        });
}

// Helper function to prevent XSS
function escapeHtml(unsafe) {
    if (unsafe === null || unsafe === undefined) return '';
    return unsafe
        .toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

function saveQuickProduct() {
    const name = document.getElementById('quick_product_name').value;
    const price = document.getElementById('quick_product_price').value;
    const hsn = document.getElementById('quick_product_hsn').value;
    const gstRate = document.getElementById('quick_product_gst').value;
    const unit = document.getElementById('quick_product_unit').value;
    const category = document.getElementById('quick_product_category').value;
    const description = document.getElementById('quick_product_description').value;
    
    if (!name || !price || !hsn || !gstRate || !unit) {
        alert('Please fill in all required fields');
        return;
    }
    
    // Send AJAX request to create product
    fetch('/api/products/quick-add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({
            name: name,
            price: parseFloat(price),
            hsn_code: hsn,
            gst_rate: parseFloat(gstRate),
            unit: unit,
            category: category,
            description: description
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Add new product to the products array
            products.push(data.product);
            
            // Add to product table
            const tbody = document.getElementById('productTableBody');
            const row = document.createElement('tr');
            row.setAttribute('data-category', data.product.category);
            row.innerHTML = `
                <td>
                    <strong>${data.product.name}</strong>
                    ${data.product.description ? `<br><small class="text-muted">${data.product.description}</small>` : ''}
                </td>
                <td><span class="badge bg-secondary">${data.product.category}</span></td>
                <td>${data.product.hsn_code}</td>
                <td>₹${data.product.price.toFixed(2)}</td>
                <td>${data.product.gst_rate.toFixed(1)}%</td>
                <td>${data.product.unit}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-primary" onclick="selectProduct(${data.product.id})">
                        Select
                    </button>
                </td>
            `;
            tbody.appendChild(row);
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('quickAddProductModal'));
            modal.hide();
            
            // Clear form
            document.getElementById('quickAddProductForm').reset();
            document.getElementById('quick_product_gst').value = '18';
            document.getElementById('quick_product_unit').value = 'Nos';
            document.getElementById('quick_product_category').value = 'General';
            
            // Auto-select the new product if we're in product selection mode
            if (currentItemRow) {
                selectProduct(data.product.id);
            }
        } else {
            alert('Error adding product: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error adding product');
    });
}

function saveQuickCustomer() {
    const name = document.getElementById('quick_customer_name').value;
    const email = document.getElementById('quick_customer_email').value;
    const phone = document.getElementById('quick_customer_phone').value;
    const address = document.getElementById('quick_customer_address').value;
    const isGuest = document.getElementById('quick_customer_guest').checked;
    
    if (!name) {
        alert('Customer name is required');
        return;
    }
    
    // Send AJAX request to create customer
    fetch('/api/customers/quick-add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: name,
            email: email,
            phone: phone,
            address: address,
            is_guest: isGuest
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Add to customer select
            const select = document.getElementById('customer_select');
            const option = document.createElement('option');
            option.value = data.id;
            option.textContent = data.name + (isGuest ? ' (Guest)' : '');
            option.selected = true;
            select.appendChild(option);
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('quickCustomerModal'));
            modal.hide();
            
            // Clear form
            document.getElementById('quickCustomerForm').reset();
            document.getElementById('quick_customer_guest').checked = true;
            
            updateFormButtons();
        } else {
            alert('Error adding customer');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error adding customer');
    });
}

// Reset product search and show recent products
function resetProductSearch() {
    // Clear search field and category filter
    document.getElementById('productSearch').value = '';
    document.getElementById('categoryFilter').value = '';
    
    // Show loading indicator and hide messages
    document.getElementById('productLoadingIndicator').style.display = 'block';
    document.getElementById('noProductsMessage').style.display = 'none';
    
    // Clear current table content
    document.getElementById('productTableBody').innerHTML = '';
    
    // Fetch recent products
    fetch('/api/products/recent')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            const tbody = document.getElementById('productTableBody');
            
            // Hide loading indicator
            document.getElementById('productLoadingIndicator').style.display = 'none';
            
            // Check if we got any products
            if (data.products && data.products.length > 0) {
                // Populate the table with products
                data.products.forEach(product => {
                    const row = document.createElement('tr');
                    row.dataset.category = product.category || 'General';
                    
                    // Build name cell content with custom fields if available
                    let nameContent = `<strong>${escapeHtml(product.name)}</strong>`;
                    if (product.description) {
                        nameContent += `<br><small class="text-muted">${escapeHtml(product.description)}</small>`;
                    }
                    
                    // Add any searchable custom fields as badges below the description
                    if (product.custom_fields && Object.keys(product.custom_fields).length > 0) {
                        nameContent += '<div class="mt-1">';
                        for (const [fieldName, fieldData] of Object.entries(product.custom_fields)) {
                            nameContent += `<span class="badge bg-info me-1" title="${escapeHtml(fieldData.display_name)}">${escapeHtml(fieldData.display_name)}: ${escapeHtml(fieldData.value)}</span>`;
                        }
                        nameContent += '</div>';
                    }
                    
                    row.innerHTML = `
                        <td>${nameContent}</td>
                        <td><span class="badge bg-secondary">${escapeHtml(product.category || 'General')}</span></td>
                        <td>${escapeHtml(product.hsn_code)}</td>
                        <td>₹${parseFloat(product.price).toFixed(2)}</td>
                        <td>${parseFloat(product.gst_rate).toFixed(1)}%</td>
                        <td>${escapeHtml(product.unit)}</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-primary" onclick="selectProduct(${product.id})">
                                Select
                            </button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
            } else {
                // Show no products message
                document.getElementById('noProductsMessage').style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error fetching recent products:', error);
            document.getElementById('productLoadingIndicator').style.display = 'none';
            document.getElementById('noProductsMessage').style.display = 'block';
            document.getElementById('noProductsMessage').querySelector('p').textContent = 'Error loading recent products. Please try again.';
        });
}

// Event listeners
const customerSelect = document.getElementById('customer_select');
if (customerSelect) {
    customerSelect.addEventListener('change', updateFormButtons);
}
</script>
{% endblock %}
